# 인원 컬럼 Enter 키 자동 행 추가 수정 완료

## 문제 상황
직무별 인원 입력 테이블에서 **인원 컬럼에서 Enter를 눌러도 새 행이 추가되지 않는** 문제가 발생했습니다.

```
1. 직무코드 입력 (예: A001)
2. 인원 입력 (예: 1)
3. Enter 키 입력
4. ❌ 새 행이 추가되지 않음!
```

## 원인 분석

### 문제 코드 (Line 373)
**파일**: [job_role_table.py](src/ui/job_role_table.py)

**변경 전**:
```python
if col == COL_HEADCOUNT:
    self._ensure_row_items(row)
    self._set_job_name_readonly(row)
    job_code = (self.item(row, COL_JOB_CODE).text() or "").strip()  # ← 문제!
    headcount = (self.item(row, COL_HEADCOUNT).text() or "").strip()
    if job_code and headcount:
        # 새 행 추가 로직...
```

### 왜 문제인가?

#### 1. COL_JOB_CODE는 cellWidget 사용
```python
# JobCodeCellWidget이 설치되어 있음
self.setCellWidget(row, COL_JOB_CODE, JobCodeCellWidget(...))
```

#### 2. self.item()은 None 반환
```python
# cellWidget이 있는 셀에는 QTableWidgetItem이 없음
job_code = (self.item(row, COL_JOB_CODE).text() or "").strip()
# → self.item(row, COL_JOB_CODE)는 None!
# → job_code는 항상 빈 문자열 ""
```

#### 3. 조건 실패
```python
if job_code and headcount:  # job_code가 ""이므로 항상 False
    # 새 행 추가 로직 실행 안 됨!
```

### 올바른 방법
cellWidget에서 직무코드를 가져와야 합니다:
```python
widget = self.cellWidget(row, COL_JOB_CODE)
if widget is not None and hasattr(widget, "get_code"):
    job_code = widget.get_code()
```

## 해결 방법

### 수정된 코드 (Line 370-383)
**파일**: [job_role_table.py](src/ui/job_role_table.py)

**변경 후**:
```python
if col == COL_HEADCOUNT:
    self._ensure_row_items(row)
    self._set_job_name_readonly(row)

    # 직무코드 가져오기 (cellWidget 사용)
    job_code = ""
    widget = self.cellWidget(row, COL_JOB_CODE)
    if widget is not None and hasattr(widget, "get_code"):
        job_code = (widget.get_code() or "").strip()

    headcount = (self.item(row, COL_HEADCOUNT).text() or "").strip()
    logging.debug("JOB_TABLE Enter in HEADCOUNT: job_code=%s, headcount=%s", job_code, headcount)

    # 직무코드·인원 있으면 자동으로 다음 행 추가 및 이동
    if job_code and headcount:
        next_row = row + 1
        if next_row >= self.rowCount():
            parent = self.parent()
            if hasattr(parent, "add_empty_row") and callable(getattr(parent, "add_empty_row")):
                parent.add_empty_row()
                next_row = self.rowCount() - 1
            else:
                self.insertRow(next_row)
                self._ensure_row_items(next_row)
                self._set_job_name_readonly(next_row)
        self._ensure_row_items(next_row)
        self._set_job_name_readonly(next_row)
        self.setCurrentCell(next_row, COL_JOB_CODE)
        widget = self.cellWidget(next_row, COL_JOB_CODE)
        if widget is not None and hasattr(widget, "_code_input"):
            widget._code_input.setFocus()
        else:
            item = self.item(next_row, COL_JOB_CODE)
            if item is not None:
                self.editItem(item)
        return
```

### 주요 변경 사항

1. **cellWidget 사용** (Line 375-378)
   ```python
   widget = self.cellWidget(row, COL_JOB_CODE)
   if widget is not None and hasattr(widget, "get_code"):
       job_code = (widget.get_code() or "").strip()
   ```

2. **디버그 로그 추가** (Line 381)
   ```python
   logging.debug("JOB_TABLE Enter in HEADCOUNT: job_code=%s, headcount=%s", job_code, headcount)
   ```

## 동작 흐름

### Before (이전)
```
1. 사용자: 직무코드 "A001" 입력
2. 사용자: 인원 "1" 입력
3. 사용자: Enter 키 입력
   ↓
4. keyPressEvent 호출
   ↓
5. job_code = self.item(row, COL_JOB_CODE).text()
   → job_code = "" (cellWidget이므로 None)
   ↓
6. if job_code and headcount:
   → if "" and "1":  # False!
   ↓
7. ❌ 새 행 추가 안 됨
```

### After (현재)
```
1. 사용자: 직무코드 "A001" 입력
2. 사용자: 인원 "1" 입력
3. 사용자: Enter 키 입력
   ↓
4. keyPressEvent 호출
   ↓
5. widget = self.cellWidget(row, COL_JOB_CODE)
   job_code = widget.get_code()
   → job_code = "A001" ✅
   ↓
6. if job_code and headcount:
   → if "A001" and "1":  # True!
   ↓
7. ✅ 새 행 자동 추가
8. ✅ 커서가 새 행의 직무코드로 이동
```

## 테스트 시나리오

### 정상 케이스
```
1. 직무코드 입력: A001 (소장)
2. Tab으로 다음 컬럼 이동
3. 인원 입력: 1
4. Enter 키 입력
   ↓
✅ 새 행 자동 추가
✅ 커서가 새 행의 직무코드로 이동
```

### 데이터 없는 경우
```
1. 직무코드 비어있음
2. 인원 입력: 1
3. Enter 키 입력
   ↓
❌ 새 행 추가 안 됨 (정상 - 직무코드 필요)
✅ 현재 셀에 머물기
```

```
1. 직무코드 입력: A001
2. 인원 비어있음
3. Enter 키 입력
   ↓
❌ 새 행 추가 안 됨 (정상 - 인원 필요)
✅ 현재 셀에 머물기
```

## 디버그 로그

### 성공 케이스
```
DEBUG:root:JOB_TABLE Enter in HEADCOUNT: job_code=A001, headcount=1
```

### 실패 케이스 (직무코드 없음)
```
DEBUG:root:JOB_TABLE Enter in HEADCOUNT: job_code=, headcount=1
```

### 실패 케이스 (인원 없음)
```
DEBUG:root:JOB_TABLE Enter in HEADCOUNT: job_code=A001, headcount=
```

## 기술적 배경

### cellWidget vs item

#### cellWidget
```python
# 커스텀 위젯 (JobCodeCellWidget, QComboBox 등)
widget = table.cellWidget(row, col)
table.setCellWidget(row, col, custom_widget)
```

#### item
```python
# 일반 QTableWidgetItem (텍스트만 표시)
item = table.item(row, col)
table.setItem(row, col, QTableWidgetItem("text"))
```

### 혼용 시 주의사항
1. **cellWidget이 있으면 item은 None**
   - cellWidget과 item은 동시에 존재할 수 없음
   - cellWidget을 설치하면 기존 item은 제거됨

2. **데이터 접근 방법**
   - cellWidget: `widget.get_code()`, `widget.text()` 등 커스텀 메서드
   - item: `item.text()`, `item.setText()` 등 표준 메서드

3. **혼재된 테이블 처리**
   - 각 컬럼에 맞는 방법 사용
   - COL_JOB_CODE: cellWidget 사용
   - COL_HEADCOUNT: item 사용

## 관련 클래스

### JobCodeCellWidget
```python
class JobCodeCellWidget(QWidget):
    def get_code(self) -> str:
        """현재 선택된 직무코드 반환"""
        return self._code_input.text().strip()
```

### JobRoleTable._get_job_code
```python
def _get_job_code(self, row: int) -> str:
    """직무코드를 안전하게 가져오기 (cellWidget 우선)"""
    widget = self.table.cellWidget(row, COL_JOB_CODE)
    if isinstance(widget, JobCodeCellWidget):
        return widget.get_code()
    # fallback...
```

## 결론

cellWidget(JobCodeCellWidget)을 사용하는 컬럼에서는 `self.item()`이 아닌 `self.cellWidget()`을 사용하여 데이터를 가져와야 합니다.

**수정 전**: item으로 접근 → 항상 빈 문자열 → 조건 실패 → 행 추가 안 됨 ❌

**수정 후**: cellWidget으로 접근 → 올바른 직무코드 → 조건 성공 → 행 자동 추가 ✅

이제 **인원 입력 후 Enter 키를 누르면 자동으로 새 행이 추가**됩니다!

## 관련 파일
- **수정 파일**: [job_role_table.py](src/ui/job_role_table.py)
- **수정 메서드**: `JobRoleTableWidget.keyPressEvent()`
- **수정 라인**: 370-400
