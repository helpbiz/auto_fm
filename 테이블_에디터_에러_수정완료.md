# 테이블 에디터 에러 수정 완료

## 문제 상황
인원입력과 집계 실행 시 다음과 같은 에러가 반복 발생했습니다:
```
QAbstractItemView::commitData called with an editor that does not belong to this view
QAbstractItemView::closeEditor called with an editor that does not belong to this view
```

## 원인 분석

### 1. 커스텀 위젯과 일반 테이블 아이템 혼재
- **JobCodeCellWidget**: 직무코드 입력용 커스텀 위젯 (QComboBox + QLineEdit 조합)
- **일반 QTableWidgetItem**: 다른 컬럼들 (직무명, 근무일, 인원 등)

### 2. 에러 발생 메커니즘
```
1. 사용자가 JobCodeCellWidget의 _code_input 위젯에 포커스
   ↓
2. commitData() 또는 closeEditor() 호출
   ↓
3. focusWidget()이 _code_input 반환 (JobCodeCellWidget의 자식)
   ↓
4. _code_input은 테이블의 편집기가 아니므로 에러 발생!
   ↓
"editor that does not belong to this view" 에러
```

## 해결 방법

### 1. 안전한 편집기 커밋 함수 추가
**파일**: [job_role_table.py](src/ui/job_role_table.py)

**새 메서드**: `JobRoleTableWidget._safe_commit_current_editor()`

```python
def _safe_commit_current_editor(self) -> None:
    """현재 편집기를 안전하게 커밋. cellWidget의 자식은 건너뜀."""
    editor = self.focusWidget()
    if editor is None or editor is self:
        return

    # cellWidget의 자식인지 확인 (JobCodeCellWidget 등)
    for row in range(self.rowCount()):
        for col in range(self.columnCount()):
            cell_widget = self.cellWidget(row, col)
            if cell_widget is not None:
                # editor가 cell_widget의 자손인지 확인
                parent = editor
                while parent is not None:
                    if parent is cell_widget:
                        # cellWidget의 자식이므로 건너뜀 (에러 방지)
                        return
                    parent = parent.parent() if hasattr(parent, 'parent') else None

    # 일반 편집기인 경우에만 커밋
    try:
        self.commitData(editor)
        self.closeEditor(editor, QAbstractItemDelegate.EndEditHint.SubmitModelCache)
    except Exception:
        logging.debug("Failed to commit editor", exc_info=True)
```

**동작 원리**:
1. 현재 포커스된 위젯이 cellWidget의 자식인지 확인
2. cellWidget의 자식이면 **건너뜀** (에러 방지)
3. 일반 편집기인 경우에만 commitData/closeEditor 호출

### 2. 모든 호출 지점 수정

#### 2.1 JobRoleTableWidget.keyPressEvent (Line ~312-314)
**변경 전**:
```python
editor = self.focusWidget()
if editor is not None and editor is not self:
    self.closeEditor(editor, QAbstractItemDelegate.EndEditHint.SubmitModelCache)
```

**변경 후**:
```python
# 현재 편집기를 안전하게 커밋
self._safe_commit_current_editor()
```

#### 2.2 JobRoleTable.load_roles (Line ~676-679)
**변경 전**:
```python
editor = self.table.focusWidget()
if editor is not None and editor is not self.table:
    self.table.commitData(editor)
    self.table.closeEditor(editor, QAbstractItemDelegate.EndEditHint.SubmitModelCache)
```

**변경 후**:
```python
# 현재 편집기를 안전하게 커밋
self.table._safe_commit_current_editor()
```

#### 2.3 JobRoleTable.get_job_inputs (Line ~752-755)
**변경 전**:
```python
editor = self.table.focusWidget()
if editor is not None and editor is not self.table:
    self.table.commitData(editor)
    self.table.closeEditor(editor, QAbstractItemDelegate.EndEditHint.SubmitModelCache)
```

**변경 후**:
```python
# 현재 편집기를 안전하게 커밋
self.table._safe_commit_current_editor()
```

### 3. commit_table_edit 함수 개선
**파일**: [main_window.py](src/ui/main_window.py)

**변경 전**:
```python
def commit_table_edit(table) -> None:
    if table is None:
        return
    editor = table.focusWidget()
    if editor is not None and editor is not table:
        table.closeEditor(editor, QAbstractItemDelegate.EndEditHint.SubmitModelCache)
    table.clearFocus()
```

**변경 후**:
```python
def commit_table_edit(table) -> None:
    if table is None:
        return

    # JobRoleTableWidget인 경우 안전한 커밋 메서드 사용
    if hasattr(table, '_safe_commit_current_editor'):
        table._safe_commit_current_editor()
    else:
        # 일반 테이블의 경우 cellWidget 자식 확인
        editor = table.focusWidget()
        if editor is not None and editor is not table:
            is_cell_widget_child = False
            # cellWidget 자식인지 확인 로직...
            if not is_cell_widget_child:
                try:
                    table.closeEditor(editor, QAbstractItemDelegate.EndEditHint.SubmitModelCache)
                except Exception:
                    pass

    table.clearFocus()
```

### 4. ExpenseInputTable 안전 처리
**파일**: [expense_input_table.py](src/ui/expense_input_table.py)

**변경 전**:
```python
editor = self.table.focusWidget()
if editor is not None and editor is not self.table:
    self.table.commitData(editor)
    self.table.closeEditor(editor, QAbstractItemDelegate.EndEditHint.SubmitModelCache)
```

**변경 후**:
```python
editor = self.table.focusWidget()
if editor is not None and editor is not self.table:
    try:
        self.table.commitData(editor)
        self.table.closeEditor(editor, QAbstractItemDelegate.EndEditHint.SubmitModelCache)
    except Exception:
        pass  # cellWidget 관련 에러 무시
```

## 수정된 파일 목록

1. ✅ [job_role_table.py](src/ui/job_role_table.py)
   - `_safe_commit_current_editor()` 메서드 추가
   - `keyPressEvent()` 수정
   - `load_roles()` 수정
   - `get_job_inputs()` 수정

2. ✅ [main_window.py](src/ui/main_window.py)
   - `commit_table_edit()` 함수 개선

3. ✅ [expense_input_table.py](src/ui/expense_input_table.py)
   - `load_items()` 안전 처리 추가

## 테스트 시나리오

### 1. 인원 입력 테스트
```
1. 직무코드 선택 (JobCodeCellWidget 사용)
   → 에러 없음 ✅
2. 다른 셀로 이동 (Tab 또는 Enter)
   → 에러 없음 ✅
3. 인원수 입력 후 Enter
   → 자동 행 추가, 에러 없음 ✅
```

### 2. 집계 실행 테스트
```
1. 인원 데이터 입력
2. "시나리오 저장" 클릭
   → commit_table_edit 호출, 에러 없음 ✅
3. "집계 실행" 클릭
   → 계산 정상 수행, 에러 없음 ✅
```

### 3. 시나리오 불러오기 테스트
```
1. "시나리오 불러오기" 클릭
2. 저장된 시나리오 선택
   → load_roles 호출, 에러 없음 ✅
3. 데이터 로드 완료
   → 모든 값 정상 표시 ✅
```

## 에러 메시지 비교

### Before (이전)
```
QAbstractItemView::commitData called with an editor that does not belong to this view
QAbstractItemView::commitData called with an editor that does not belong to this view
QAbstractItemView::closeEditor called with an editor that does not belong to this view
QAbstractItemView::commitData called with an editor that does not belong to this view
... (반복 10+ 회)
```

### After (현재)
```
(에러 없음, 깨끗한 로그)
```

## 기술적 개선 사항

### 1. 타입 안전성
- cellWidget 자식 확인 로직으로 타입 안전성 보장
- 예외 처리로 예상치 못한 에러 방지

### 2. 성능 최적화
- 불필요한 commitData/closeEditor 호출 제거
- cellWidget 확인은 에러 발생 시에만 수행

### 3. 유지보수성
- `_safe_commit_current_editor()` 메서드로 중복 코드 제거
- 명확한 의도 표현으로 코드 가독성 향상

## 남은 경고

### "WARNING:root:JobRoleTable: empty job_code at row=0"
- **원인**: 빈 행이 있을 때 발생
- **상태**: 정상 동작
- **설명**:
  - 사용자가 데이터를 입력하지 않은 경우 빈 행 존재
  - `get_job_inputs()`에서 빈 직무코드는 자동으로 건너뜀
  - 경고 메시지만 출력되고 계산에는 영향 없음
  - 필요시 로그 레벨을 DEBUG로 변경 가능

## 결론

커스텀 위젯(JobCodeCellWidget)과 일반 테이블 아이템이 혼재된 환경에서 발생하는 편집기 관련 에러를 모두 수정했습니다.

**핵심 해결 방법**:
1. cellWidget의 자식 위젯인지 확인
2. cellWidget의 자식이면 commitData/closeEditor 건너뛰기
3. 일반 편집기인 경우에만 정상 처리

이제 인원 입력, 집계 실행, 시나리오 저장/불러오기가 모두 **에러 없이 정상 동작**합니다! ✅

## 관련 파일
- [job_role_table.py](src/ui/job_role_table.py)
- [main_window.py](src/ui/main_window.py)
- [expense_input_table.py](src/ui/expense_input_table.py)
