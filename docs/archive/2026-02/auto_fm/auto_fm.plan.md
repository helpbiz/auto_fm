# auto_fm 시설관리 원가 계산 프로그램 - 계획 문서

> **Feature**: auto_fm 전체 프로그램
> **Created**: 2026-02-14
> **Status**: Plan
> **Author**: PDCA System
> **Source**: auto_fm_fin.xlsx 분석 결과

---

## 1. 프로젝트 개요 (Project Overview)

### 1.1 배경 및 목적

**배경:**
- 건물 자동집하시설 운영 및 유지관리 원가를 정확하게 산정할 필요
- 노무비, 경비, 일반관리비, 이윤 등을 체계적으로 계산하는 도구 필요
- 정부 고시 임금(품셈)에 따른 인건비 계산 자동화 필요

**목적:**
- 사용자가 직무별 인원과 경비 항목을 입력하면 자동으로 원가를 산정하는 PyQt6 기반 데스크톱 애플리케이션 개발
- 시나리오별 원가 비교 기능 제공
- Excel/PDF 형식으로 결과 내보내기
- 데이터 무결성 보장 (SQLite 기반 로컬 DB)

### 1.2 프로젝트 범위

**포함 사항:**
1. 직무별 인원 입력 및 노무비 자동 계산
2. 경비 항목 입력 및 인적 보험료 자동 계산
3. 일반관리비 및 이윤 계산
4. 시나리오 저장/불러오기/비교
5. Excel/PDF 내보내기
6. 마스터 데이터 관리 (직무코드, 임금, 경비 항목)
7. 연도별 임금 데이터 관리

**제외 사항:**
- 웹 버전 (데스크톱 전용)
- 다중 사용자 동시 접근 (단일 사용자 로컬 앱)
- 클라우드 동기화
- 실시간 협업 기능

### 1.3 성공 기준

1. **기능 완성도**: 노무비, 경비, 일반관리비, 이윤 계산이 정확하게 동작
2. **사용성**: 사용자가 5분 이내에 기본 시나리오 입력 및 결과 확인 가능
3. **안정성**: 100개 시나리오 저장/불러오기 시 데이터 손실 없음
4. **성능**: 인원 수 변경 시 500ms 이내 자동 계산 완료
5. **확장성**: 신규 직무코드 및 경비 항목 추가 용이

---

## 2. 주요 기능 (Key Features)

### 2.1 핵심 기능

#### F1. 직무별 인원 입력 및 노무비 계산
- **우선순위**: P0 (Critical)
- **설명**:
  - 17개 표준 직무코드 제공 (관리감독자, 공장장, 기능공 등)
  - 사용자가 직무별 인원 수, 근무일수 입력
  - 2023~2026년 정부 고시 임금 기준 노무비 자동 계산
- **입력**: 직무코드, 인원 수, 근무일수
- **출력**: 기본급, 제수당, 인적 보험료, 산정 금액

#### F2. 경비 항목 입력 및 관리
- **우선순위**: P0 (Critical)
- **설명**:
  - 3개 그룹(고정비, 변동비, 대행비)으로 구분
  - 경비코드별 세부 항목 입력 (규격, 단위, 수량, 단가)
  - 인적 보험료 7종 자동 계산 및 반영
- **입력**: 경비코드, 세부 항목(규격, 단위, 수량, 단가)
- **출력**: 월계, 연간합계

#### F3. 인적 보험료 자동 계산
- **우선순위**: P0 (Critical)
- **설명**:
  - 직무별 인원 변경 시 7가지 보험료 자동 계산
  - 산재, 국민연금, 고용, 건강, 장기요양, 임금채권, 석면피해 분담금
- **트리거**: 직무별 인원 테이블 itemChanged 시그널
- **계산 로직**: 노무비 기준 보험료율 적용

#### F4. 시나리오 저장/불러오기
- **우선순위**: P1 (High)
- **설명**:
  - 시나리오별 입력 데이터 저장 (SQLite)
  - 저장된 시나리오 불러오기
  - 시나리오 불러오기 시 기존 입력 데이터 보존
- **데이터**: 기본 정보, 직무별 인원, 경비 세부 항목

#### F5. 시나리오 비교
- **우선순위**: P2 (Medium)
- **설명**:
  - 최대 2개 시나리오 선택하여 비교
  - 노무비, 경비, 총액 차이 시각화
  - 비교 결과 테이블 표시
- **출력**: 시나리오별 총액, 차액, 증감율

#### F6. Excel/PDF 내보내기
- **우선순위**: P1 (High)
- **설명**:
  - 계산 결과를 Excel 또는 PDF로 내보내기
  - 노무비 상세, 경비 상세, 요약 정보 포함
- **포맷**: .xlsx, .pdf

#### F7. 마스터 데이터 관리
- **우선순위**: P1 (High)
- **설명**:
  - 직무코드 정보 관리 (migration/seed 방식)
  - 연도별 임금 데이터 관리 (JSON → DB 마이그레이션)
  - 경비 항목 기본 템플릿 제공
- **데이터**: md_job_roles, md_wages, md_expense_items

### 2.2 부가 기능

#### F8. 일반관리비 및 이윤 계산
- **우선순위**: P2 (Medium)
- **설명**: 노무비 + 경비 기준 일반관리비(%) 및 이윤(%) 자동 계산
- **입력**: 일반관리비율, 이윤율
- **출력**: 일반관리비, 이윤, 총액

#### F9. 도넛 차트 시각화
- **우선순위**: P3 (Low)
- **설명**: 노무비, 경비, 일반관리비, 이윤 비율을 도넛 차트로 표시
- **라이브러리**: matplotlib

---

## 3. 기술 스택 (Tech Stack)

### 3.1 언어 및 프레임워크
- **언어**: Python 3.12+
- **UI 프레임워크**: PyQt6
- **데이터베이스**: SQLite3
- **차트**: matplotlib

### 3.2 주요 라이브러리
- **openpyxl**: Excel 파일 읽기/쓰기
- **reportlab / QPrinter**: PDF 생성
- **dataclasses**: 데이터 모델 정의

### 3.3 프로젝트 구조
```
auto_fm/
├── src/
│   ├── main.py                 # 애플리케이션 진입점
│   ├── domain/                 # 비즈니스 로직
│   │   ├── db.py               # 데이터베이스 연결
│   │   ├── migration_runner.py # DB 마이그레이션
│   │   ├── calculator/         # 계산 로직
│   │   │   ├── labor.py        # 노무비 계산
│   │   │   └── expense.py      # 경비 계산
│   │   ├── masterdata/         # 마스터 데이터 관리
│   │   │   ├── repo.py         # 데이터 접근
│   │   │   └── service.py      # 서비스 로직
│   │   ├── result/             # 결과 집계
│   │   └── scenario_input/     # 시나리오 입출력
│   ├── ui/                     # UI 컴포넌트
│   │   ├── main_window.py      # 메인 윈도우
│   │   ├── input_panel.py      # 입력 패널
│   │   ├── job_role_table.py   # 직무별 인원 테이블
│   │   ├── expense_sub_item_table.py # 경비 입력 테이블
│   │   ├── labor_detail_table.py     # 노무비 상세 테이블
│   │   ├── expense_detail_table.py   # 경비 상세 테이블
│   │   ├── summary_panel.py    # 요약 패널
│   │   ├── donut_chart.py      # 도넛 차트
│   │   └── compare/            # 비교 페이지
│   └── utils/                  # 유틸리티
├── data/                       # 초기 데이터
│   └── wages_master.json       # 연도별 임금 데이터
├── docs/                       # 문서
└── tests/                      # 테스트
```

---

## 4. 개발 계획 (Development Plan)

### 4.1 Phase 1: 핵심 기능 구현 (완료)
- ✅ 데이터베이스 스키마 설계
- ✅ 마이그레이션 시스템 구축
- ✅ 직무별 인원 입력 UI
- ✅ 노무비 계산 로직
- ✅ 경비 입력 UI
- ✅ 기본 집계 및 요약

### 4.2 Phase 2: 자동 계산 및 데이터 보존 (진행 중)
- ✅ 인적 보험료 자동 계산
- ✅ 시나리오 불러오기 시 데이터 보존
- ✅ 인원수 기반 경비 계산
- ✅ 노무비/경비 상세 테이블 합계 행
- ✅ 경비코드 컬럼 추가
- ⏳ 자동 계산 동작 확인 및 버그 수정

### 4.3 Phase 3: 비교 및 내보내기 (예정)
- ⏳ 시나리오 비교 기능 개선
- ⏳ Excel 내보내기 포맷 개선
- ⏳ PDF 내보내기 레이아웃 개선

### 4.4 Phase 4: 안정화 및 최적화 (예정)
- ⏳ 전체 기능 테스트
- ⏳ 성능 최적화
- ⏳ 에러 처리 개선
- ⏳ 사용자 가이드 작성

---

## 5. 데이터 모델 (Data Model)

### 5.1 핵심 엔티티

#### Job Role (직무)
```python
@dataclass
class JobRole:
    job_code: str       # 직무코드 (예: MGR01, ENG01)
    job_name: str       # 직무명 (예: 관리감독자, 공장장)
    job_type: str       # 직종 (예: 관리, 기술)
    year: int           # 기준연도
    base_wage: int      # 기본급
    is_standard: bool   # 표준 직무 여부
```

#### Expense Item (경비 항목)
```python
@dataclass
class ExpenseItem:
    exp_code: str       # 경비코드 (예: FIX_INS_INDUST)
    exp_name: str       # 경비명 (예: 산재보험료)
    group_code: str     # 그룹 (FIXED, VARIABLE, AGENCY)
    sort_order: int     # 정렬 순서
    scenario_id: str    # 시나리오 ID
```

#### Expense Sub Item (경비 세부 항목)
```python
@dataclass
class ExpenseSubItem:
    exp_code: str       # 경비코드
    sub_code: str       # 세부코드
    sub_name: str       # 항목명
    spec: str           # 규격
    unit: str           # 단위
    quantity: float     # 수량
    unit_price: int     # 단가
    amount: int         # 금액
    remark: str         # 비고
```

### 5.2 계산 로직

#### 노무비 계산
```
노무비 = Σ (직무별 인원 × 근무일수 × (기본급 + 제수당 + 보험료))

보험료 = {
    산재보험료: 기본급 × 1.65%
    국민연금: 기본급 × 4.5%
    고용보험료: 기본급 × 0.65%
    건강보험료: 기본급 × 3.545%
    장기요양: 건강보험료 × 12.95%
    임금채권: 기본급 × 0.08%
    석면피해: 기본급 × 0.005%
}
```

#### 경비 계산
```
월계 = Σ (세부 항목 수량 × 단가)
연간합계 = 월계 × 12 (기본)
연간합계 = 월계 × 인원합계 × 12 (인원수 기반 항목)

인원수 기반 항목: 피복비, 식대, 건강검진비, 의약품비
```

---

## 6. 위험 요소 및 대응 (Risks & Mitigation)

### 6.1 기술적 위험

| 위험 | 영향도 | 확률 | 대응책 |
|------|--------|------|--------|
| PyQt6 호환성 문제 | 중 | 중 | PyQt5 fallback 코드 유지 |
| DB 마이그레이션 실패 | 높음 | 낮음 | 백업 생성, 롤백 메커니즘 |
| 계산 로직 오류 | 높음 | 중 | 단위 테스트 강화, 수동 검증 |
| 성능 저하 (대량 데이터) | 중 | 중 | Signal blocking, 비동기 처리 고려 |

### 6.2 사용성 위험

| 위험 | 영향도 | 확률 | 대응책 |
|------|--------|------|--------|
| 사용자 입력 오류 | 중 | 높음 | Validation 강화, 툴팁 제공 |
| 데이터 손실 | 높음 | 낮음 | 자동 저장, 시나리오 백업 |
| UI 복잡성 | 중 | 중 | 사용자 가이드 작성, 간소화 |

---

## 7. 다음 단계 (Next Steps)

1. **현재 상태 점검**:
   - ✅ Design 문서 작성 완료 (ui.design.md)
   - ✅ 대부분 기능 구현 완료
   - ⏳ 자동 계산 동작 검증 필요

2. **즉시 해결할 문제**:
   - 직무별 인원 입력 → 노무비 상세 자동 계산 동작 확인
   - 디버깅 및 리팩토링

3. **다음 PDCA 단계**:
   - `/pdca analyze auto_fm` - 전체 시스템 Gap 분석
   - `/pdca report auto_fm` - 완료 보고서 작성

4. **장기 계획**:
   - 사용자 가이드 작성
   - 설치 프로그램 패키징 (PyInstaller, Inno Setup)
   - 추가 기능 요구사항 수집

---

## 8. 참고 자료 (References)

- **소스 데이터**: `src/auto_fm_fin.xlsx` - 초기 계산 로직 및 데이터 구조
- **Design 문서**: `docs/02-design/features/ui.design.md` - UI 상세 설계
- **변경 이력**: `docs/변경된_입력방법.md` - 사용자 가이드
- **아카이브**: `docs/archive/2026-02/app-stability-and-user-manual/` - 이전 완료 사이클

---

**작성자**: PDCA System
**최종 수정**: 2026-02-14
**다음 단계**: `/pdca design auto_fm` 또는 현재 문제 해결 후 `/pdca analyze ui`
